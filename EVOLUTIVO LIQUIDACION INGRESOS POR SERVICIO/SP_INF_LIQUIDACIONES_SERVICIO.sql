CREATE OR REPLACE PROCEDURE "EXT"."SP_INF_LIQUIDACIONES_SERVICIO"(IN IN_FILENAME VARCHAR(250)) LANGUAGE SQLSCRIPT AS
BEGIN

    --versiÃ³n inicial
    DECLARE i_Tenant VARCHAR(127);
    DECLARE cReportTable CONSTANT VARCHAR(50) := 'SP_INF_LIQUIDACIONES_SERVICIO';
    DECLARE io_contador Number := 0;

    ----------------------------- HANDLER EXCEPTION -------------------------
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
		BEGIN
			CALL EXT.LIB_GLOBAL_CESCE:w_debug (i_Tenant, 'SQL ERROR_MESSAGE: ' ||
						IFNULL(::SQL_ERROR_MESSAGE,'') || '. SQL_ERROR_CODE: ' || ::SQL_ERROR_CODE, cReportTable, io_contador);
		END;

	---------------------------------------------------------------------------

    SELECT EXT.LIB_GLOBAL_CESCE:getTenantID() INTO i_Tenant FROM DUMMY;

	CALL EXT.LIB_GLOBAL_CESCE:w_debug (i_Tenant, 'INICIO PROCEDIMIENTO v01 with SESSION_USER '|| SESSION_USER, cReportTable, io_contador);

	CALL EXT.LIB_GLOBAL_CESCE:w_debug (i_Tenant, 'Se insertan datos de PAGOS en tabla EXT.INF_LIQUIDACIONES_SERVICIO ' , cReportTable, io_contador);

    --Si no existe la tabla EXT.INF_LIQUIDACIONES_SERVICIO la creamos
    IF (SELECT TABLE_NAME FROM SYS.TABLES where SCHEMA_NAME='EXT' and TABLE_NAME = 'INF_LIQUIDACIONES_SERVICIO') IS NULL THEN
	    CREATE COLUMN TABLE EXT.INF_LIQUIDACIONES_SERVICIO (
            CODIGO VARCHAR(20),
            MEDIADOR VARCHAR(50),
            IDPAIS SMALLINT CS_INT,
            SOCIEDAD VARCHAR(50),
            IDRECIBO BIGINT CS_FIXED GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1),
            CONCEPTO VARCHAR(50),
            FECHA_RECIBO_LIQUIDACION DATE CS_DAYDATE,
            ESTADO VARCHAR(10),
            REFERENCIA VARCHAR(8),
            FECHA_FACTURA DATE CS_DAYDATE,
            IDDIVISA SMALLINT CS_INT,
            MONEDA VARCHAR(5),
            IMPORTE DECIMAL(18, 3) CS_FIXED,
            PERIODSEQ BIGINT CS_FIXED,
            CREATEDATE LONGDATE CS_LONGDATE,
			MODIF_DATE LONGDATE CS_LONGDATE,
			MODIF_USER NVARCHAR(50),
            BATCHNAME VARCHAR(250)
        )UNLOAD PRIORITY 5 AUTO MERGE;

        CALL EXT.LIB_GLOBAL_CESCE :w_debug (
            i_Tenant,
            'CREADA TABLA EXT.INF_LIQUIDACIONES_SERVICIO',
            cReportTable,
            io_contador
        );
    END IF;
    
    -- Borramos registros almacenados para el fichero de entrada
    IF EXISTS(SELECT 1 FROM EXT.INF_LIQUIDACIONES_SERVICIO WHERE BATCHNAME = IN_FILENAME) THEN
    	DELETE FROM EXT.INF_LIQUIDACIONES_SERVICIO WHERE BATCHNAME = IN_FILENAME;
    	CALL EXT.LIB_GLOBAL_CESCE:w_debug (i_Tenant, 'BORRADOS ' || To_VARCHAR(::ROWCOUNT)  || ' REGISTROS EN EXT.INF_LIQUIDACIONES_SERVICIO ' , cReportTable, io_contador);
    END IF;
    
    --Insertamos registros 
    INSERT INTO EXT.INF_LIQUIDACIONES_SERVICIO(
    	CODIGO,
    	MEDIADOR,
    	IDPAIS,
    	SOCIEDAD,
    	CONCEPTO,
    	FECHA_RECIBO_LIQUIDACION,
    	ESTADO,
    	REFERENCIA,
    	FECHA_FACTURA,
    	IDDIVISA,
    	MONEDA,
    	IMPORTE,
    	PERIODSEQ,
    	CREATEDATE,
    	MODIF_DATE,
    	MODIF_USER,
    	BATCHNAME
    )
    SELECT 
    	CRH.IDMEDIADOR || '-' || CRH.IDSUBCLAVE CODIGO
    	, PA.FIRSTNAME || ' ' || PA.LASTNAME MEDIADOR
    	, CRH.IDPAIS
    	, SC.SOCIEDAD
    	, 'Comisiones por servicio' CONCEPTO
    	, ADD_DAYS(ADD_MONTHS(TO_DATE(MESCIERRE),1),-1) AS FECHA_RECIBO_LIQUIDACION
    	, CRH.ESTADOREG
    	, CRH.NUMFACTURA REFERENCIA
    	, CRH.FEC_MOVIMIENTO FECHA_FACTURA
    	, CRH.IDDIVISA
    	, (SELECT EXT.LIB_GLOBAL_CESCE:getCurrency(CRH.IDDIVISA,'').currencyISO FROM DUMMY) MONEDA
    	, CRH.IMPORTE_COBRADA IMPORTE
    	, (SELECT P.PERIODSEQ FROM CS_PERIOD P INNER JOIN CS_CALENDAR C ON P.CALENDARSEQ = C.CALENDARSEQ AND C.NAME = 'Main Monthly Calendar' AND C.REMOVEDATE >= '2200-01-01'
			WHERE STARTDATE >= TO_DATE(MESCIERRE)  AND ENDDATE <= ADD_MONTHS(TO_DATE(MESCIERRE),1)
			AND P.REMOVEDATE >= '2200-01-01') PERIODSEQ
		, CURRENT_TIMESTAMP as CREATEDATE
		, CURRENT_TIMESTAMP as MODIF_DATE
		, SESSION_USER as MODIF_USER
    	, CRH.BATCHNAME
    FROM EXT.COMISIONES_RM_HIST CRH
    LEFT JOIN CS_POSITION PO ON CRH.IDMEDIADOR || '-' || CRH.IDSUBCLAVE = PO.NAME AND PO.REMOVEDATE >= '2200-01-01 00:00:00' AND PO.ISLAST = 1
	LEFT JOIN CS_PARTICIPANT PA ON PA.PAYEESEQ = PO.PAYEESEQ AND PA.REMOVEDATE >= '2200-01-01 00:00:00' AND PA.ISLAST = 1
	LEFT JOIN EXT.SOCIEDADES_CESCE SC ON CRH.IDPAIS = SC.IDPAIS
    WHERE CRH.BATCHNAME = IN_FILENAME AND CRH.ESTADOREG = 'ENVIADA';
    
    CALL EXT.LIB_GLOBAL_CESCE:w_debug (i_Tenant, 'INSERTADOS ' || To_VARCHAR(::ROWCOUNT)  || ' REGISTROS EN EXT.INF_LIQUIDACIONES_SERVICIO ' , cReportTable, io_contador);
	
	
	CALL EXT.LIB_GLOBAL_CESCE:w_debug (i_Tenant, 'FIN PROCEDIMIENTO v01 with SESSION_USER '|| SESSION_USER, cReportTable, io_contador);
END


